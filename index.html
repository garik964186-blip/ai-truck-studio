<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Marked –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–¥–∞
    marked.setOptions({
        highlight: function(code, lang) {
            return hljs.highlightAuto(code).value;
        },
        breaks: true
    });

    // --- –§–£–ù–ö–¶–ò–Ø –ì–û–õ–û–°–û–í–û–ì–û –û–¢–í–ï–¢–ê (–í–ï–†–ù–£–õ–ê–°–¨) ---
    function speak(t) {
        window.speechSynthesis.cancel(); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ—á—å
        // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç Markdown-—Å–∏–º–≤–æ–ª–æ–≤ –∏ –∫–æ–¥–∞ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –æ–∑–≤—É—á–∫–∏
        const cleanText = t.replace(/```[\s\S]*?```/g, ' [–∫–æ–¥] ') // –ù–µ —á–∏—Ç–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π –∫–æ–¥
                           .replace(/[*#`_]/g, '')
                           .trim();
        const u = new SpeechSynthesisUtterance(cleanText);
        u.lang = 'ru-RU';
        u.rate = 1.1; 
        window.speechSynthesis.speak(u);
    }

    function toggleImageZoom(img) {
        const overlay = document.getElementById('overlay');
        img.classList.toggle('zoomed');
        overlay.style.display = img.classList.contains('zoomed') ? 'block' : 'none';
    }

    function closeAllZooms() {
        document.querySelectorAll('.gen-img').forEach(i => i.classList.remove('zoomed'));
        document.getElementById('overlay').style.display = 'none';
    }

    function tab(t){
        document.querySelectorAll('.tab-btn, .content').forEach(e=>e.classList.remove('active'));
        document.getElementById('b-'+t).classList.add('active');
        document.getElementById(t).classList.add('active');
        window.speechSynthesis.cancel(); // –ì–∞—Å–∏–º –∑–≤—É–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∫–ª–∞–¥–∫–∏
    }

    async function make(){
        const inp = document.getElementById('i-art'); const btn = document.getElementById('go-art');
        if(!inp.value) return; btn.disabled = true; btn.innerText = "‚è≥ –ì–ï–ù–ï–†–ê–¶–ò–Ø...";
        
        try {
            let p = inp.value; if(/[–∞-—è]/.test(p)) {
                const r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=en&dt=t&q=${encodeURIComponent(p)}`);
                const d = await r.json(); p = d[0][0][0];
            }
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?model=${document.getElementById('m-art').value}&seed=${Math.floor(Math.random()*1e6)}&nologo=true`;
            const img = new Image(); img.src = url;
            img.onload = () => {
                const wrap = document.createElement('div'); wrap.className = 'img-wrap';
                wrap.innerHTML = `<img src="${url}" class="gen-img" onclick="toggleImageZoom(this)"><a href="${url}" target="_blank" class="dl-btn">üì• –°–ö–ê–ß–ê–¢–¨</a>`;
                document.getElementById('imgs').prepend(wrap);
                btn.disabled = false; btn.innerText = "üöÄ –°–û–ó–î–ê–¢–¨ –ö–ê–†–¢–ò–ù–ö–£"; inp.value = '';
            };
        } catch(e) { btn.disabled = false; btn.innerText = "üöÄ –°–û–ó–î–ê–¢–¨ –ö–ê–†–¢–ò–ù–ö–£"; }
    }

    async function send(){
        const inp = document.getElementById('i-chat'); const box = document.getElementById('chat-box');
        if(!inp.value) return; const m = inp.value;
        box.innerHTML += `<div class="msg u">${m}</div>`; inp.value=''; box.scrollTop=box.scrollHeight;
        
        try {
            const model = document.getElementById('m-chat').value;
            const systemPrompt = "–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –≤ –ø—Ä–æ–µ–∫—Ç–µ '–û–¢ –ò–ì–†–£–®–ö–ò –î–û –§–£–†–´'. –¢–≤–æ–π –±–æ—Å—Å - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. –¢—ã –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–∑–±–∏—Ä–∞–µ—à—å—Å—è –≤ –∫–æ–¥–µ, –≥—Ä—É–∑–æ–≤–∏–∫–∞—Ö –ö–∞–º–ê–ó –ö5, Dongfeng –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Osmo Action. –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.";
            const r = await fetch(`https://text.pollinations.ai/${encodeURIComponent(systemPrompt + " –í–æ–ø—Ä–æ—Å –æ—Ç –±–æ—Å—Å–∞: " + m)}?model=${model}`);
            const t = await r.text();
            
            const ai = document.createElement('div'); ai.className='msg a';
            ai.innerHTML = marked.parse(t);
            box.appendChild(ai); 
            
            ai.querySelectorAll('pre code').forEach((el) => hljs.highlightElement(el));
            box.scrollTop = box.scrollHeight;
            
            // --- –¢–ï–ü–ï–†–¨ –û–ó–í–£–ß–ö–ê –°–ù–û–í–ê –¢–£–¢ ---
            speak(t); 

        } catch(e){ box.innerHTML += `<div class="msg a">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏.</div>`; }
    }

    function voice(m){
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR) return alert("–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
        const rec = new SR(); rec.lang='ru-RU';
        rec.onstart = () => document.getElementById('mic-'+m).classList.add('active');
        rec.onend = () => document.getElementById('mic-'+m).classList.remove('active');
        rec.onresult = (e) => { 
            const v = e.results[0][0].transcript; 
            if(m==='art'){ document.getElementById('i-art').value=v; make(); } 
            else { document.getElementById('i-chat').value=v; send(); }
        };
        rec.start();
    }
    function clr(){ if(confirm("–û—á–∏—Å—Ç–∏—Ç—å?")) document.getElementById('imgs').innerHTML=''; }
</script>
