<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamLine AI | FIXED VERSION</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --paper: #f4e4bc; --ink: #2c241a; --gold: #d4af37; --accent: #8b0000; --leather: #2a0505; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Helvetica', Arial, sans-serif; }
        
        .viewport { width: 100vw; height: 100vh; position: relative; perspective: 2500px; }
        .book { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; }
        .page { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transform-origin: left; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); background: var(--paper); }
        
        #p1 { z-index: 5; } #p2 { z-index: 4; } #p3 { z-index: 3; } #p4 { z-index: 2; }
        .flipped { transform: rotateY(-180deg) !important; pointer-events: none; }
        .back { position: absolute; inset: 0; transform: rotateY(180deg); backface-visibility: hidden; background: #e8d5a7; border-left: 2px solid rgba(0,0,0,0.1); }

        .paper-sheet { display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; }
        .header { padding: 15px; background: rgba(0,0,0,0.08); border-bottom: 2px solid var(--ink); text-align: center; font-weight: bold; display: flex; justify-content: space-between; align-items: center; height: 60px; flex-shrink: 0;}
        
        /* Исправлена прокрутка */
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; position: relative; }
        
        .ai-select { width: 46%; margin: 5px 2%; padding: 10px; border: 2px solid var(--ink); border-radius: 10px; background: #fff; font-size: 13px; font-weight: bold; }
        .input-bar { padding: 10px; background: rgba(255,255,255,0.4); border-top: 2px solid var(--ink); flex-shrink: 0; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .row { display: flex; gap: 10px; align-items: center; }
        .field { flex: 1; padding: 12px; border: 2px solid var(--ink); border-radius: 30px; outline: none; font-size: 16px; background: #fff; }
        .btn { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--ink); display: flex; align-items: center; justify-content: center; width: 40px; }
        
        .nav-dots { position: fixed; bottom: 80px; width: 100%; text-align: center; z-index: 100; pointer-events: none; }
        .dot { display: inline-block; width: 12px; height: 12px; background: var(--gold); border-radius: 50%; margin: 0 6px; opacity: 0.3; pointer-events: auto; transition: 0.3s; }
        .dot.active { opacity: 1; transform: scale(1.4); background: var(--accent); }
        
        .ai-msg { padding: 15px; background: rgba(255,255,255,0.6); border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--gold); position: relative; word-wrap: break-word;}
        .user-msg { text-align:right; margin-bottom:15px; padding-right:10px; font-weight: bold; color: var(--leather); }
        .mic-active { color: #ff0000 !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        #lib-modal { position: absolute; inset: 0; background: #fff; z-index: 2000; display: none; flex-direction: column; }
        .lib-frame { flex: 1; border: none; width: 100%; }
        .active-sentence { background: rgba(212, 175, 55, 0.4); border-bottom: 2px solid var(--gold); transition: all 0.3s; }

        /* Стиль для картинок */
        .art-card { margin-bottom:20px; border:4px solid var(--gold); background:#fff; border-radius: 4px; overflow: hidden; }
        .art-card img { width:100%; display:block; min-height: 200px; background: #eee; }
        .art-prompt { text-align:center; padding:8px; font-size:12px; color: var(--ink); border-top: 1px solid #ddd; }
    </style>
</head>
<body onclick="unlockAudio()">

<div class="nav-dots">
    <div class="dot active" onclick="jumpTo(1)"></div>
    <div class="dot" onclick="jumpTo(2)"></div>
    <div class="dot" onclick="jumpTo(3)"></div>
    <div class="dot" onclick="jumpTo(4)"></div>
</div>

<div class="viewport">
    <div class="book">
        
        <div class="page" id="p4">
            <div class="paper-sheet">
                <div id="lib-modal">
                    <div class="header" style="background: var(--leather); color: var(--gold);">
                        <button onclick="toggleLib()" class="btn" style="color: var(--gold);"><i class="fas fa-chevron-left"></i></button>
                        <span>LITNET БИБЛИОТЕКА</span>
                        <div style="width: 40px;"></div>
                    </div>
                    <iframe src="https://litnet.com/ru/top/all" class="lib-frame"></iframe>
                </div>
                <div class="header">
                    <button class="btn" onclick="toggleLib()"><i class="fas fa-book"></i></button>
                    <span>АУДИОКНИГА</span>
                    <button class="btn" onclick="resetBook()"><i class="fas fa-trash-alt"></i></button>
                </div>
                <div class="scroll-area" id="book-area">
                    <div id="book-content" style="font-size:18px; line-height:1.6; padding-bottom: 50px;"></div>
                    <div id="book-empty" style="text-align:center; margin-top:60px; opacity:0.6;">
                        <i class="fas fa-headphones-alt" style="font-size: 50px; color: var(--gold); margin-bottom: 20px;"></i><br>
                        Вставьте текст или загрузите из библиотеки.<br>Нажмите Play для озвучки.
                    </div>
                </div>
                <div class="input-bar">
                    <div class="row">
                        <button onclick="toggleBookPlay()" id="play-btn" class="btn" style="background: var(--gold); color: #fff; border-radius: 50%; width: 45px; height: 45px; margin-right: 5px;"><i class="fas fa-play"></i></button>
                        <input id="i-book" class="field" placeholder="Вставьте текст сюда...">
                        <button onclick="manualLoad()" class="btn"><i class="fas fa-upload"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="page" id="p3">
            <div class="paper-sheet">
                <div class="header"><span>ИНТЕЛЛЕКТ-ХАБ</span><button class="btn" onclick="clearChat()"><i class="fas fa-eraser"></i></button></div>
                <div style="padding: 5px; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.1);">
                    <select id="chat-model" class="ai-select" style="width: 96%;">
                        <option value="openai">GPT-4o (Умный)</option>
                        <option value="mistral">Mistral Large</option>
                        <option value="llama">Llama 3 (Быстрый)</option>
                    </select>
                </div>
                <div id="hub" class="scroll-area"></div>
                <div id="chat-status" style="display:none; text-align:center; font-size:12px; color:var(--accent); padding:5px;">
                    <i class="fas fa-circle-notch fa-spin"></i> Босс AI думает...
                </div>
                <div class="input-bar">
                    <div class="row">
                        <button id="m-chat" onclick="runMic('i-chat', askAI, 'm-chat')" class="btn"><i class="fas fa-microphone"></i></button>
                        <input id="i-chat" class="field" placeholder="Спросить Босса..." onkeydown="if(event.key==='Enter') askAI()">
                        <button onclick="askAI()" class="btn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            <div class="back"></div>
        </div>

        <div class="page" id="p2">
            <div class="paper-sheet">
                <div class="header"><span>ВИЗУАЛИЗАТОР</span><button class="btn" onclick="document.getElementById('gallery').innerHTML=''"><i class="fas fa-trash"></i></button></div>
                <div style="display:flex; justify-content: center; padding: 5px; gap: 5px;">
                    <select id="art-model" class="ai-select"><option value="flux">FLUX.1 (Ultra)</option><option value="midjourney">Midjourney</option></select>
                    <select id="art-style" class="ai-select">
                        <option value="">Без стиля</option>
                        <option value="photorealistic, 8k">Фотореализм</option>
                        <option value="anime style">Аниме</option>
                        <option value="cyberpunk">Киберпанк</option>
                    </select>
                </div>
                <div id="gallery" class="scroll-area"></div>
                <div id="art-status" style="display:none; text-align:center; font-size:12px; color:var(--accent); padding:5px;">
                     <i class="fas fa-paint-brush fa-spin"></i> Рисую...
                </div>
                <div class="input-bar">
                    <div class="row">
                        <button id="m-art" onclick="runMic('i-art', drawArt, 'm-art')" class="btn"><i class="fas fa-microphone"></i></button>
                        <input id="i-art" class="field" placeholder="Опишите образ..." onkeydown="if(event.key==='Enter') drawArt()">
                        <button onclick="drawArt()" class="btn"><i class="fas fa-magic"></i></button>
                    </div>
                </div>
            </div>
            <div class="back"></div>
        </div>

        <div class="page" id="p1" onclick="jumpTo(2)">
            <div class="paper-sheet" style="background:var(--leather); border:10px double var(--gold); align-items:center; justify-content:center; text-align:center;">
                <div style="width:85%; padding:10px; background:#fff; transform:rotate(-2deg); box-shadow:0 20px 50px #000; margin-bottom: 25px;">
                    <video autoplay loop muted playsinline style="width:100%; display:block;">
                        <source src="https://raw.githubusercontent.com/garik964186-blip/ai-truck-studio/main/1768452401066.mp4">
                    </video>
                </div>
                <h1 style="color:var(--gold); letter-spacing:5px; text-shadow: 2px 2px #000;">STREAMLINE AI</h1>
                <p style="color:var(--gold); opacity:0.8;">BOSS ULTIMATE SYSTEM v2.0</p>
                <div style="color:var(--gold); margin-top:40px; border:2px solid var(--gold); padding:12px 25px; border-radius:40px; font-weight:bold;">ВОЙТИ В СИСТЕМУ</div>
            </div>
            <div class="back"></div>
        </div>
        
    </div>
</div>

<script>
    let step = 1;
    const synth = window.speechSynthesis;
    let bookData = { sentences: [], index: 0, isPlaying: false, utterance: null };

    // --- 1. СИСТЕМА ЗВУКА (FIXED) ---
    // Браузеры блокируют звук без жеста. Этот хак "размораживает" аудио при первом клике.
    let audioUnlocked = false;
    function unlockAudio() {
        if (!audioUnlocked) {
            const u = new SpeechSynthesisUtterance('');
            u.volume = 0;
            synth.speak(u);
            audioUnlocked = true;
        }
    }

    function speakText(text) {
        // Отменяем старое, чтобы не было очереди
        synth.cancel();
        // Убираем markdown символы для чистоты речи
        const clean = text.replace(/[*#`_]/g, '');
        const u = new SpeechSynthesisUtterance(clean);
        u.lang = 'ru-RU';
        u.rate = 1.1; 
        u.pitch = 1.0;
        synth.speak(u);
    }

    // --- 2. НАВИГАЦИЯ (ИСПРАВЛЕННЫЙ СВАЙП) ---
    // Добавлена проверка, что свайп "сильнее" прокрутки, чтобы не ломать скролл
    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener('touchstart', e => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    }, {passive: true});

    document.addEventListener('touchend', e => {
        let touchEndX = e.changedTouches[0].clientX;
        let touchEndY = e.changedTouches[0].clientY;
        
        let diffX = touchStartX - touchEndX;
        let diffY = touchStartY - touchEndY;

        // Срабатываем только если движение по горизонтали ЯВНО больше, чем по вертикали
        // И само движение достаточно длинное (>60px)
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 60) {
            if (diffX > 0 && step < 4) jumpTo(step + 1); // Свайп влево (вперед)
            else if (diffX < 0 && step > 1) jumpTo(step - 1); // Свайп вправо (назад)
        }
    });

    function jumpTo(s) {
        if(s === step) return;
        step = s;
        // Переворот страниц
        for(let i=1; i<=3; i++) {
            const page = document.getElementById('p'+i);
            if(s > i) page.classList.add('flipped');
            else page.classList.remove('flipped');
        }
        // Точки навигации
        document.querySelectorAll('.dot').forEach((d, i) => {
            d.classList.toggle('active', i === s-1);
        });
    }

    // --- 3. ИНТЕЛЛЕКТ-ХАБ (FIXED AI) ---
    async function askAI() {
        let input = document.getElementById('i-chat');
        let prompt = input.value.trim();
        let hub = document.getElementById('hub');
        let model = document.getElementById('chat-model').value;
        
        if(!prompt) return;
        
        input.value = '';
        input.blur(); // Скрываем клавиатуру
        
        // Показываем сообщение пользователя
        hub.innerHTML += `<div class="user-msg">Босс: ${prompt}</div>`;
        hub.scrollTo(0, hub.scrollHeight);
        
        document.getElementById('chat-status').style.display = 'block';

        try {
            // Убрали переводчик (он часто падал). Нейросеть поймет русский напрямую.
            // Используем прямой fetch с кодированием URI
            const systemPrompt = "Отвечай на русском языке. Будь краток и полезен. ";
            const finalUrl = `https://text.pollinations.ai/${encodeURIComponent(systemPrompt + prompt)}?model=${model}`;
            
            const response = await fetch(finalUrl);
            if (!response.ok) throw new Error('Network error');
            
            const text = await response.text();
            
            hub.innerHTML += `<div class="ai-msg"><b>AI (${model}):</b><br>${marked.parse(text)}</div>`;
            speakText(text); // Озвучка ответа
        } catch(e) {
            hub.innerHTML += `<div class="ai-msg" style="border-color:red;"><b>Ошибка:</b> Не удалось связаться с сервером AI. Попробуйте еще раз.</div>`;
        }
        
        document.getElementById('chat-status').style.display = 'none';
        hub.scrollTo(0, hub.scrollHeight);
    }

    function clearChat() { 
        synth.cancel(); 
        document.getElementById('hub').innerHTML = ''; 
    }

    // --- 4. ВИЗУАЛИЗАТОР ---
    async function drawArt() {
        let input = document.getElementById('i-art');
        let prompt = input.value.trim();
        let gallery = document.getElementById('gallery');
        let model = document.getElementById('art-model').value;
        let style = document.getElementById('art-style').value;
        
        if(!prompt) return;
        input.value = '';
        input.blur();

        document.getElementById('art-status').style.display = 'block';

        // Генерация случайного сида для уникальности
        let seed = Math.floor(Math.random() * 1000000);
        // Формируем запрос (добавляем стиль к промпту)
        let fullPrompt = `${prompt}, ${style}`;
        let url = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?model=${model}&seed=${seed}&nologo=true`;

        // Создаем картинку (предзагрузка)
        let img = new Image();
        img.onload = () => {
            document.getElementById('art-status').style.display = 'none';
            let div = document.createElement('div');
            div.className = 'art-card';
            div.innerHTML = `
                <img src="${url}" onclick="window.open('${url}', '_blank')">
                <div class="art-prompt">${prompt}</div>
            `;
            gallery.insertBefore(div, gallery.firstChild);
        };
        img.onerror = () => {
            document.getElementById('art-status').style.display = 'none';
            alert('Ошибка загрузки изображения');
        };
        img.src = url;
    }

    // --- 5. АУДИОКНИГА (ПОЛНАЯ ПЕРЕРАБОТКА) ---
    function toggleLib() {
        const modal = document.getElementById('lib-modal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function manualLoad() {
        let rawText = document.getElementById('i-book').value;
        if(!rawText) return;
        
        // Разбиваем текст на предложения более умно
        bookData.sentences = rawText.match(/[^.!?]+[.!?]+["']?|[\s\S]+$/g) || [rawText];
        bookData.index = 0;
        bookData.isPlaying = false;
        
        renderBook();
        document.getElementById('i-book').value = '';
        document.getElementById('book-empty').style.display = 'none';
    }

    function renderBook() {
        const container = document.getElementById('book-content');
        container.innerHTML = bookData.sentences.map((t, i) => 
            `<span id="s${i}" onclick="jumpBookTo(${i})" style="cursor:pointer;">${t} </span>`
        ).join('');
    }
    
    function jumpBookTo(idx) {
        bookData.index = idx;
        highlightSentence();
        if(bookData.isPlaying) {
            synth.cancel();
            playNextSentence();
        }
    }

    function toggleBookPlay() {
        const btn = document.getElementById('play-btn');
        
        if (bookData.isPlaying) {
            // ПАУЗА
            bookData.isPlaying = false;
            synth.cancel();
            btn.innerHTML = '<i class="fas fa-play"></i>';
        } else {
            // СТАРТ
            if (bookData.sentences.length === 0) return;
            bookData.isPlaying = true;
            btn.innerHTML = '<i class="fas fa-pause"></i>';
            if (synth.speaking) synth.cancel();
            playNextSentence();
        }
    }

    function playNextSentence() {
        if (!bookData.isPlaying) return;
        
        if (bookData.index >= bookData.sentences.length) {
            bookData.isPlaying = false;
            document.getElementById('play-btn').innerHTML = '<i class="fas fa-play"></i>';
            return;
        }

        highlightSentence();

        const text = bookData.sentences[bookData.index];
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ru-RU';
        utterance.rate = 1.0;
        
        utterance.onend = () => {
            if (bookData.isPlaying) {
                bookData.index++;
                playNextSentence();
            }
        };

        utterance.onerror = (e) => {
            console.error("Speech Error", e);
            // Если ошибка, пробуем пропустить предложение
            if (bookData.isPlaying) {
                bookData.index++;
                playNextSentence();
            }
        };

        synth.speak(utterance);
    }

    function highlightSentence() {
        document.querySelectorAll('.active-sentence').forEach(e => e.classList.remove('active-sentence'));
        const el = document.getElementById('s' + bookData.index);
        if (el) {
            el.classList.add('active-sentence');
            el.scrollIntoView({
