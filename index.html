<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StreamLine AI | BOSS EDITION V7</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --paper: #f4e4bc; --ink: #2c241a; --gold: #d4af37; --accent: #8b0000; --leather: #2a0505; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100dvh; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* ДВИЖОК КНИГИ */
        .viewport { width: 100vw; height: 100dvh; position: relative; perspective: 2500px; }
        .book { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; }
        .page { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transform-origin: left; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); background: var(--paper); display: flex; flex-direction: column; box-shadow: inset -50px 0 100px rgba(0,0,0,0.05); }
        
        #p1 { z-index: 5; } #p2 { z-index: 4; } #p3 { z-index: 3; } #p4 { z-index: 2; }
        .flipped { transform: rotateY(-180deg) !important; pointer-events: none; }
        .back { position: absolute; inset: 0; transform: rotateY(180deg); backface-visibility: hidden; background: #e8d5a7; border-left: 2px solid rgba(0,0,0,0.1); }

        /* ИНТЕРФЕЙС */
        .header { padding: 12px; background: rgba(0,0,0,0.1); border-bottom: 2px solid var(--ink); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .header span { font-weight: 900; letter-spacing: 1px; color: var(--ink); }

        /* СКРОЛЛ БЕЗ КОНФЛИКТОВ */
        .scroll-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            touch-action: pan-y !important; /* Важно: разрешаем только вертикальный свайп внутри */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .search-box { padding: 10px; background: rgba(212, 175, 55, 0.15); border-bottom: 1px solid var(--gold); }
        .search-row { display: flex; gap: 8px; margin-bottom: 5px; }
        .search-input { flex: 1; padding: 10px; border: 1px solid var(--ink); border-radius: 8px; font-size: 14px; background: #fff; }

        .ai-select { flex: 1; padding: 10px; border: 2px solid var(--ink); border-radius: 10px; background: #fff; font-size: 13px; font-weight: bold; }
        
        .input-bar { padding: 15px; background: rgba(255,255,255,0.4); border-top: 2px solid var(--ink); padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .row { display: flex; gap: 10px; align-items: center; }
        .field { flex: 1; padding: 14px; border: 2px solid var(--ink); border-radius: 30px; outline: none; font-size: 16px; background: #fff; }
        
        .btn { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--ink); display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; }
        .btn-gold { background: var(--gold); color: #fff; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .nav-dots { position: fixed; bottom: 90px; width: 100%; text-align: center; z-index: 100; pointer-events: none; }
        .dot { display: inline-block; width: 10px; height: 10px; background: var(--gold); border-radius: 50%; margin: 0 5px; opacity: 0.3; pointer-events: auto; }
        .dot.active { opacity: 1; transform: scale(1.4); background: var(--accent); }

        /* ГАЛЕРЕЯ */
        .art-card { margin-bottom: 20px; border: 4px solid #fff; outline: 2px solid var(--gold); background: #fff; border-radius: 2px; overflow: hidden; }
        .art-card img { width: 100%; display: block; min-height: 250px; background: #ddd; }
        
        .ai-msg { padding: 15px; background: rgba(255,255,255,0.7); border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--gold); }
        .active-sentence { background: rgba(212, 175, 55, 0.4); border-bottom: 2px solid var(--gold); }
    </style>
</head>
<body onclick="initAudio()">

<div class="nav-dots">
    <div class="dot active" onclick="jumpTo(1)"></div>
    <div class="dot" onclick="jumpTo(2)"></div>
    <div class="dot" onclick="jumpTo(3)"></div>
    <div class="dot" onclick="jumpTo(4)"></div>
</div>

<div class="viewport">
    <div class="book">
        
        <div class="page" id="p4">
            <div class="header">
                <label class="btn"><i class="fas fa-file-download"></i><input type="file" accept=".fb2" style="display:none" onchange="loadFB2(this)"></label>
                <span>FB2 TOP SEARCH</span>
                <button class="btn" onclick="clearBook()"><i class="fas fa-trash-alt"></i></button>
            </div>
            
            <div class="search-box">
                <div class="search-row">
                    <input id="q-book" class="search-input" placeholder="Название или автор...">
                    <button class="btn" onclick="searchFB2Site()"><i class="fas fa-search"></i></button>
                </div>
                <div style="font-size: 11px; opacity: 0.7; text-align: center;">Поиск сразу выдает прямые ссылки на fb2.top</div>
            </div>

            <div class="scroll-area" id="book-area">
                <div id="book-content" style="font-size:19px; line-height:1.7;"></div>
                <div id="book-empty" style="text-align:center; margin-top:50px; opacity:0.6;">
                    <i class="fas fa-book-reader" style="font-size:50px; color:var(--gold);"></i><br><br>
                    Введите название книги выше.<br>После скачивания нажмите <i class="fas fa-file-download"></i>
                </div>
            </div>

            <div class="input-bar">
                <div class="row">
                    <button onclick="togglePlay()" id="play-btn" class="btn btn-gold"><i class="fas fa-play"></i></button>
                    <input id="i-book" class="field" placeholder="Вставьте текст или ссылку...">
                    <button onclick="manualLoad()" class="btn"><i class="fas fa-check-circle"></i></button>
                </div>
            </div>
        </div>

        <div class="page" id="p3">
            <div class="header"><span>ИНТЕЛЛЕКТ-ХАБ</span><button class="btn" onclick="document.getElementById('hub').innerHTML=''"><i class="fas fa-eraser"></i></button></div>
            <div style="padding: 8px 15px; display: flex; gap: 10px; background: rgba(0,0,0,0.03);">
                <select id="chat-model" class="ai-select">
                    <option value="openai">GPT-4o (Boss)</option>
                    <option value="mistral">Mistral Large</option>
                    <option value="llama">Llama 3.3</option>
                </select>
            </div>
            <div id="hub" class="scroll-area"></div>
            <div class="input-bar">
                <div class="row">
                    <button id="m-chat" onclick="runMic('i-chat', askAI)" class="btn"><i class="fas fa-microphone"></i></button>
                    <input id="i-chat" class="field" placeholder="Спросить у ИИ...">
                    <button onclick="askAI()" class="btn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            <div class="back"></div>
        </div>

        <div class="page" id="p2">
            <div class="header"><span>ВИЗУАЛИЗАТОР</span><button class="btn" onclick="document.getElementById('gallery').innerHTML=''"><i class="fas fa-sync-alt"></i></button></div>
            <div style="padding: 8px 15px; display: flex; gap: 10px; background: rgba(0,0,0,0.03);">
                <select id="art-model" class="ai-select"><option value="flux">FLUX.1</option><option value="midjourney">Midjourney</option></select>
                <select id="art-style" class="ai-select"><option value="photorealistic">Реализм</option><option value="cyberpunk">Киберпанк</option></select>
            </div>
            <div id="gallery" class="scroll-area"></div>
            <div class="input-bar">
                <div class="row">
                    <button id="m-art" onclick="runMic('i-art', drawArt)" class="btn"><i class="fas fa-microphone"></i></button>
                    <input id="i-art" class="field" placeholder="Что нарисовать?">
                    <button onclick="drawArt()" class="btn"><i class="fas fa-magic"></i></button>
                </div>
            </div>
            <div class="back"></div>
        </div>

        <div class="page" id="p1" onclick="jumpTo(2)">
            <div style="flex:1; background:var(--leather); border:12px double var(--gold); display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                <div style="width:85%; padding:10px; background:#fff; box-shadow:0 20px 60px #000; margin-bottom:30px;">
                    <video autoplay loop muted playsinline style="width:100%; display:block;">
                        <source src="https://raw.githubusercontent.com/garik964186-blip/ai-truck-studio/main/1768452401066.mp4">
                    </video>
                </div>
                <h1 style="color:var(--gold); letter-spacing:5px; font-size:26px; text-shadow: 2px 2px #000;">STREAMLINE AI</h1>
                <p style="color:var(--gold); opacity:0.8; font-weight:bold; margin-top:10px;">ULTIMATE BOSS v7.0</p>
                <div style="margin-top:40px; color:var(--gold); border:2px solid var(--gold); padding:12px 30px; border-radius:40px; font-weight:bold; background: rgba(255,255,255,0.1);">ВОЙТИ</div>
            </div>
            <div class="back"></div>
        </div>
        
    </div>
</div>

<script>
    let step = 1, audioReady = false;
    const synth = window.speechSynthesis;
    let bookData = { text: [], idx: 0, playing: false };

    // --- УМНЫЙ КОНТРОЛЛЕР СВАЙПА (ФИКС СКРОЛЛА КАРТИНОК) ---
    let sX = 0, sY = 0, distY = 0, distX = 0;

    document.addEventListener('touchstart', e => {
        sX = e.touches[0].clientX;
        sY = e.touches[0].clientY;
    }, {passive: true});

    document.addEventListener('touchend', e => {
        distX = sX - e.changedTouches[0].clientX;
        distY = sY - e.changedTouches[0].clientY;

        // Листаем страницу только если:
        // 1. Горизонтальный свайп длиннее 100px
        // 2. Горизонтальное движение ВДВОЕ сильнее вертикального (защита от случайных срабатываний при скролле)
        if (Math.abs(distX) > 100 && Math.abs(distX) > Math.abs(distY) * 2) {
            if (distX > 0 && step < 4) jumpTo(step + 1);
            if (distX < 0 && step > 1) jumpTo(step - 1);
        }
    });

    function jumpTo(s) {
        for(let i=1; i<=3; i++) document.getElementById('p'+i).classList.toggle('flipped', s > i);
        document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === s-1));
        step = s;
    }

    // --- ПОИСК FB2 ПО ПРЯМЫМ ССЫЛКАМ ---
    function searchFB2Site() {
        let q = document.getElementById('q-book').value;
        if(!q) return;
        // Специальный поисковый запрос, который ведет на прямые скачивания
        let searchUrl = `https://www.google.com/search?q=site:fb2.top+${encodeURIComponent(q)}+download`;
        window.open(searchUrl, '_blank');
    }

    // --- ОБРАБОТКА FB2 ---
    function loadFB2(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
            const ps = xml.getElementsByTagName("p");
            let txt = "";
            for(let p of ps) txt += p.textContent + " ";
            processBook(txt);
        };
        reader.readAsText(file);
    }

    function processBook(txt) {
        bookData.text = txt.match(/[^.!?]+[.!?]+["']?|[\s\S]+$/g) || [txt];
        bookData.idx = 0;
        document.getElementById('book-content').innerHTML = bookData.text.map((t,i) => `<span id="s${i}">${t} </span>`).join('');
        document.getElementById('book-empty').style.display = 'none';
        document.getElementById('book-area').scrollTop = 0;
    }

    function manualLoad() { 
        let v = document.getElementById('i-book').value; 
        if(v.startsWith('http')) {
            window.open(v, '_blank'); // Если вставили ссылку, просто открываем её
        } else if(v) {
            processBook(v); 
            document.getElementById('i-book').value='';
        }
    }

    // --- ИИ ФУНКЦИИ ---
    async function askAI() {
        let i = document.getElementById('i-chat'), q = i.value, h = document.getElementById('hub'), m = document.getElementById('chat-model').value;
        if(!q) return; i.value = '';
        h.innerHTML += `<div style="text-align:right; margin-bottom:15px; font-weight:bold;">Босс: ${q}</div>`;
        h.scrollTop = h.scrollHeight;
        try {
            let res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(q)}?model=${m}`);
            let txt = await res.text();
            h.innerHTML += `<div class="ai-msg"><b>AI:</b><br>${marked.parse(txt)}</div>`;
            speak(txt);
        } catch(e) { h.innerHTML += `<div>Ошибка сети.</div>`; }
        h.scrollTop = h.scrollHeight;
    }

    async function drawArt() {
        let i = document.getElementById('i-art'), q = i.value, g = document.getElementById('gallery'), m = document.getElementById('art-model').value, s = document.getElementById('art-style').value;
        if(!q) return; i.value = '';
        let url = `https://image.pollinations.ai/prompt/${encodeURIComponent(q + ", " + s)}?model=${m}&seed=${Math.floor(Math.random()*99999)}&nologo=true`;
        let div = document.createElement('div');
        div.className = 'art-card';
        div.innerHTML = `<img src="${url}" loading="lazy"><p style="padding:10px; font-size:12px; font-weight:bold;">${q}</p>`;
        g.insertBefore(div, g.firstChild);
    }

    // --- ГОЛОСОВОЙ ДВИЖОК ---
    function initAudio() { if(!audioReady) { synth.speak(new SpeechSynthesisUtterance('')); audioReady = true; } }
    function speak(t) { synth.cancel(); let u = new SpeechSynthesisUtterance(t.substring(0,500)); u.lang='ru-RU'; synth.speak(u); }
    
    function togglePlay() {
        if(!bookData.text.length) return;
        bookData.playing = !bookData.playing;
        document.getElementById('play-btn').innerHTML = bookData.playing ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
        if(bookData.playing) runReader(); else synth.cancel();
    }

    function runReader() {
        if(!bookData.playing || bookData.idx >= bookData.text.length) return;
        document.querySelectorAll('.active-sentence').forEach(e => e.classList.remove('active-sentence'));
        let el = document.getElementById('s' + bookData.idx);
        if(el) { el.classList.add('active-sentence'); el.scrollIntoView({block:'center', behavior:'smooth'}); }
        
        let u = new SpeechSynthesisUtterance(bookData.text[bookData.idx]);
        u.lang = 'ru-RU';
        u.onend = () => { if(bookData.playing) { bookData.idx++; runReader(); } };
        synth.speak(u);
    }

    function clearBook() { synth.cancel(); bookData={text:[], idx:0, playing:false}; document.getElementById('book-content').innerHTML=''; document.getElementById('book-empty').style.display='block'; }

    function runMic(id, cb) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return;
        const rec = new SpeechRecognition(); rec.lang = 'ru-RU';
        rec.onresult = (e) => { document.getElementById(id).value = e.results[0][0].transcript; cb(); };
        rec.start();
    }
</script>
</body>
</html>
