<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BOSS BOOK FINAL</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --paper: #f4e4bc; --ink: #2c241a; --gold: #d4af37; --accent: #8b0000; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body, html { width: 100%; height: 100%; background: #000; overflow: hidden; font-family: "Georgia", serif; }
        
        .viewport { width: 100vw; height: 100dvh; position: relative; perspective: 2000px; }
        .book { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; }
        
        /* –°–¢–†–ê–ù–ò–¶–´ */
        .page { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transform-origin: left; transform-style: preserve-3d; transition: transform 0.6s ease-in-out; pointer-events: none; z-index: 1; }
        .flipped { transform: rotateY(-180deg); z-index: 10 !important; }
        
        .paper-sheet { position: absolute; inset: 0; background: var(--paper); background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png'); color: var(--ink); display: flex; flex-direction: column; box-shadow: inset 10px 0 30px rgba(0,0,0,0.2); pointer-events: auto; backface-visibility: hidden; }
        .back { transform: rotateY(180deg); background: #e8d5a7; border-left: 2px solid rgba(0,0,0,0.1); }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .header { height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 2px solid var(--ink); background: rgba(0,0,0,0.05); font-weight: bold; }
        .ai-select { width: 92%; margin: 8px auto; padding: 10px; border: 2px solid var(--ink); border-radius: 10px; background: #fff; font-size: 14px; }
        
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .status-bar { height: 25px; font-size: 12px; text-align: center; color: var(--accent); font-weight: bold; }

        .ai-box { background: rgba(255,255,255,0.3); padding: 10px; border-radius: 8px; position: relative; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .ai-box.playing { border-left: 4px solid var(--gold); background: rgba(212, 175, 55, 0.1); }
        .speaker-btn { position: absolute; right: 8px; top: 8px; font-size: 18px; color: var(--accent); opacity: 0.5; padding: 5px; }
        
        .input-bar { padding: 10px; background: rgba(255,255,255,0.5); border-top: 1px solid rgba(0,0,0,0.1); padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .row { display: flex; gap: 8px; max-width: 600px; margin: 0 auto; }
        .field { flex: 1; padding: 12px; border-radius: 20px; border: 1.5px solid #aaa; outline: none; font-size: 16px; }
        .btn { background: none; border: none; font-size: 24px; color: var(--ink); width: 40px; display: flex; align-items: center; justify-content: center; }

        #z-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; }
    </style>
</head>
<body onclick="unlockAudio()">

<div id="z-overlay" onclick="this.style.display='none'"><img id="z-img" style="width:100%"></div>

<div class="viewport">
    <div class="book">
        
        <div class="page" id="p3">
            <div class="paper-sheet">
                <div class="header">
                    <span>üîÆ GEMINI BOSS</span>
                    <i class="fas fa-trash" onclick="clearChat()" style="opacity:0.3"></i>
                </div>
                <select id="model" class="ai-select">
                    <option value="openai">GPT-4o</option>
                    <option value="deepseek">DeepSeek R1</option>
                    <option value="llama">Llama 3.3</option>
                </select>
                <div id="status" class="status-bar"></div>
                <div id="chat-box" class="scroll-area"></div>
                <div class="input-bar">
                    <div class="row">
                        <button onclick="runMic()" class="btn" id="mic"><i class="fas fa-microphone"></i></button>
                        <input type="text" id="input" class="field" placeholder="–°–ª—É—à–∞—é, –ë–æ—Å—Å...">
                        <button onclick="sendMsg()" class="btn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="page" id="p2" style="z-index: 2;">
            <div class="paper-sheet">
                <div class="header">üé® –≠–°–ö–ò–ó–´</div>
                <div id="art-box" class="scroll-area"></div>
                <div class="input-bar">
                    <div class="row">
                        <input type="text" id="input-art" class="field" placeholder="–ù–∞—Ä–∏—Å—É–π...">
                        <button onclick="genArt()" class="btn"><i class="fas fa-magic"></i></button>
                    </div>
                </div>
            </div>
            <div class="back"></div>
        </div>

        <div class="page" id="p1" style="z-index: 3;">
            <div class="paper-sheet" style="background:#2b0000; color:var(--gold); align-items:center; justify-content:center;">
                <h1 style="font-size:40px">–ö–ù–ò–ì–ê</h1>
                <p style="letter-spacing:5px">BOSS EDITION</p>
                <p style="margin-top:50px; font-size:12px; opacity:0.5">‚¨Ö –°–ú–ê–•–ù–ò –í–õ–ï–í–û</p>
            </div>
            <div class="back"></div>
        </div>

    </div>
</div>

<script>
    let step = 1, audioOk = false;
    const synth = window.speechSynthesis;
    const flipSnd = new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3');
    
    // –ü–ª–µ–µ—Ä
    let chunks = [], chunkIdx = 0, isTalking = false, activeText = "";

    function unlockAudio() { if(!audioOk) { synth.speak(new SpeechSynthesisUtterance('')); audioOk = true; } }

    // –õ–û–ì–ò–ö–ê –ì–û–õ–û–°–ê
    function speak(text, restart = false) {
        unlockAudio();
        if (restart || text !== activeText) {
            synth.cancel();
            activeText = text;
            chunks = text.replace(/[#*`_]/g, '').trim().match(/[^.!?]+[.!?]+/g) || [text];
            chunkIdx = 0;
            isTalking = true;
            playChunk();
        } else {
            if (isTalking) { synth.cancel(); isTalking = false; document.getElementById('status').innerText = "‚è∏ –ü–∞—É–∑–∞"; }
            else { isTalking = true; playChunk(); }
        }
        updateVisuals();
    }

    function playChunk() {
        if (!isTalking || chunkIdx >= chunks.length) {
            if(chunkIdx >= chunks.length) { isTalking = false; activeText = ""; document.getElementById('status').innerText = ""; updateVisuals(); }
            return;
        }
        const u = new SpeechSynthesisUtterance(chunks[chunkIdx]);
        u.lang = 'ru-RU';
        u.rate = 1.05;
        u.onstart = () => document.getElementById('status').innerText = "üìñ –ß–∏—Ç–∞—é...";
        u.onend = () => { if(isTalking) { chunkIdx++; playChunk(); } };
        synth.speak(u);
    }

    function updateVisuals() {
        document.querySelectorAll('.ai-box').forEach(b => {
            const t = b.querySelector('.ai-content').innerText.replace('AI:', '').trim();
            b.classList.toggle('playing', isTalking && t === activeText);
        });
    }

    async function sendMsg() {
        const inp = document.getElementById('input'), box = document.getElementById('chat-box'), m = document.getElementById('model').value;
        if (!inp.value) return;
        const val = inp.value; inp.value = '';
        box.insertAdjacentHTML('afterbegin', `<div style="text-align:right; font-size:12px; opacity:0.6; margin:5px">–í—ã: ${val}</div>`);
        document.getElementById('status').innerText = "–î—É–º–∞—é...";
        
        try {
            const r = await fetch(`https://text.pollinations.ai/prompt/${encodeURIComponent(val)}?model=${m}`);
            const d = await r.text();
            addAiBox(d);
            save();
            speak(d, true);
        } catch(e) { document.getElementById('status').innerText = "–û—à–∏–±–∫–∞"; }
    }

    function addAiBox(txt) {
        const div = document.createElement('div');
        div.className = "ai-box";
        div.innerHTML = `<i class="fas fa-volume-up speaker-btn" onclick="event.stopPropagation(); speak(\`${txt}\`, true)"></i><div class="ai-content"><b>AI:</b> ${marked.parse(txt)}</div>`;
        div.onclick = () => speak(txt, false);
        document.getElementById('chat-box').insertAdjacentElement('afterbegin', div);
    }

    async function genArt() {
        const inp = document.getElementById('input-art'), box = document.getElementById('art-box');
        if(!inp.value) return;
        const txt = inp.value; inp.value = '';
        document.getElementById('status').innerText = "–†–∏—Å—É—é...";
        const tr = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(txt)}&langpair=ru|en`);
        const td = await tr.json();
        const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(td.responseData.translatedText)}?model=flux&nologo=true`;
        box.insertAdjacentHTML('afterbegin', `<img src="${url}" style="width:100%; border-radius:10px; margin-bottom:10px" onclick="openZ(this.src)">`);
        document.getElementById('status').innerText = "";
    }

    function openZ(u) { document.getElementById('z-img').src = u; document.getElementById('z-overlay').style.display = 'flex'; }
    function save() { localStorage.setItem('boss_save_v5', document.getElementById('chat-box').innerHTML); }
    function load() {
        const s = localStorage.getItem('boss_save_v5');
        if(s) {
            document.getElementById('chat-box').innerHTML = s;
            document.querySelectorAll('.ai-box').forEach(b => {
                const txt = b.querySelector('.ai-content').innerText.replace('AI:', '').trim();
                b.onclick = () => speak(txt, false);
                b.querySelector('.speaker-btn').onclick = (e) => { e.stopPropagation(); speak(txt, true); };
            });
        }
    }
    function clearChat() { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å?')) { localStorage.removeItem('boss_save_v5'); location.reload(); } }

    function runMic() {
        const R = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!R) return;
        const r = new R(); r.lang = 'ru-RU';
        r.onstart = () => document.getElementById('mic').style.color = 'red';
        r.onresult = (e) => { document.getElementById('input').value = e.results[0][0].transcript; sendMsg(); };
        r.onend = () => document.getElementById('mic').style.color = 'inherit';
        r.start();
    }

    window.onload = load;

    // –õ–∏—Å—Ç–∞–Ω–∏–µ
    let sX = 0;
    document.addEventListener('touchstart', e => sX = e.touches[0].clientX);
    document.addEventListener('touchend', e => {
        if(document.getElementById('z-overlay').style.display === 'flex') return;
        let d = sX - e.changedTouches[0].clientX;
        if (Math.abs(d) > 70) {
            if (d > 0 && step < 3) { document.getElementById('p'+step).classList.add('flipped'); step++; flipSnd.play(); }
            else if (d < 0 && step > 1) { step--; document.getElementById('p'+step).classList.remove('flipped'); flipSnd.play(); }
        }
    });
</script>
</body>
</html>
