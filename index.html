<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BOSS BOOK | REPAIRED</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --paper: #f4e4bc; --ink: #2c241a; --gold: #d4af37; --accent: #8b0000; --leather: #1a0505; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; width: 100%; height: 100vh; background: #000; overflow: hidden; font-family: "Georgia", serif; }

        /* Сцена */
        .viewport { width: 100vw; height: 100vh; perspective: 1500px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .book { width: 100%; height: 100%; max-width: 600px; position: relative; transform-style: preserve-3d; }
        
        /* Страницы */
        .page { 
            position: absolute; width: 100%; height: 100%; top: 0; left: 0; 
            transform-origin: left center; transform-style: preserve-3d; 
            transition: transform 0.6s ease-in-out; 
            background: var(--paper);
            box-shadow: inset 10px 0 30px rgba(0,0,0,0.1);
        }

        /* Слои страниц */
        #p1 { z-index: 3; } /* Обложка сверху */
        #p2 { z-index: 2; }
        #p3 { z-index: 1; }

        /* Логика переворота */
        .flipped { transform: rotateY(-180deg); pointer-events: none; } /* Важно: flipped не ловит клики */
        
        /* Оборотная сторона */
        .back { position: absolute; inset: 0; transform: rotateY(180deg); backface-visibility: hidden; background: #e8d5a7; border-left: 2px solid rgba(0,0,0,0.1); }
        
        /* Содержимое (Лицевая сторона) */
        .front { 
            position: absolute; inset: 0; backface-visibility: hidden; 
            display: flex; flex-direction: column; background: var(--paper);
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
        }

        /* --- UI Элементы --- */
        .header { padding: 15px; border-bottom: 2px solid var(--ink); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.05); }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
        
        /* Обложка */
        .cover-design {
            height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--leather); color: var(--gold); border: 10px double var(--gold);
            cursor: pointer; /* Показываем, что кликабельно */
        }
        
        /* Чат */
        .user-msg { background: rgba(0,0,0,0.05); padding: 8px; border-radius: 8px; margin: 5px 0 5px auto; max-width: 80%; text-align: right; }
        .ai-msg { padding: 8px; border-left: 3px solid var(--accent); margin: 5px 0; }
        
        /* Ввод */
        .input-bar { padding: 15px; background: rgba(255,255,255,0.8); display: flex; gap: 10px; }
        .field { flex: 1; padding: 10px; border: 2px solid var(--ink); border-radius: 20px; font-size: 16px; }
        .btn { border: none; background: none; font-size: 20px; color: var(--ink); }

        /* Навигация (Точки) */
        .nav-dots { 
            position: fixed; bottom: 80px; left: 0; right: 0; 
            display: flex; justify-content: center; gap: 20px; 
            z-index: 9999; /* Самый верхний слой */
        }
        .dot { 
            width: 15px; height: 15px; border-radius: 50%; 
            background: rgba(212, 175, 55, 0.5); border: 2px solid #000; 
            transition: 0.3s; cursor: pointer;
        }
        .dot.active { background: #fff; transform: scale(1.3); border-color: var(--accent); }
    </style>
</head>
<body>

<div class="nav-dots">
    <div class="dot active" id="dot1" onclick="goToPage(1)"></div>
    <div class="dot" id="dot2" onclick="goToPage(2)"></div>
    <div class="dot" id="dot3" onclick="goToPage(3)"></div>
</div>

<div class="viewport">
    <div class="book">
        
        <div class="page" id="p3">
            <div class="front">
                <div class="header">
                    <b>BOSS AI</b>
                    <button class="btn" onclick="clearChat()"><i class="fas fa-trash"></i></button>
                </div>
                <div id="chat-box" class="scroll-area">
                    <div style="text-align:center; opacity:0.5; margin-top:50px;">История пуста</div>
                </div>
                <div class="input-bar">
                    <input type="text" id="inp" class="field" placeholder="Запрос...">
                    <button class="btn" onclick="send()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div class="page" id="p2">
            <div class="front">
                <div class="header"><b>АРТ-СТУДИЯ</b></div>
                <div id="art-box" class="scroll-area"></div>
                <div class="input-bar">
                    <input type="text" id="art-inp" class="field" placeholder="Что нарисовать?">
                    <button class="btn" onclick="draw()"><i class="fas fa-palette"></i></button>
                </div>
            </div>
            <div class="back"></div>
        </div>

        <div class="page" id="p1" onclick="goToPage(2)">
            <div class="front cover-design">
                <h1 style="border-bottom: 2px solid var(--gold);">НАША КНИГА</h1>
                <p>BOSS EDITION</p>
                <small style="opacity:0.6; margin-top:20px;">Нажми или свайпни</small>
            </div>
            <div class="back"></div>
        </div>

    </div>
</div>

<script>
    let currentPage = 1;

    // ГАРАНТИРОВАННАЯ ФУНКЦИЯ ПЕРЕХОДА
    function goToPage(n) {
        // Звук
        const audio = new Audio('https://www.soundjay.com/office/sounds/paper-flip-1.mp3');
        audio.volume = 0.5;
        audio.play().catch(()=>console.log('Audio blocked'));

        // Логика состояний
        if (n === 1) {
            // Закрыть всё (вернуть обложку)
            document.getElementById('p1').classList.remove('flipped');
            document.getElementById('p2').classList.remove('flipped');
        } else if (n === 2) {
            // Открыть обложку, показать Арт
            document.getElementById('p1').classList.add('flipped');
            document.getElementById('p2').classList.remove('flipped');
        } else if (n === 3) {
            // Открыть Арт, показать Чат
            document.getElementById('p1').classList.add('flipped');
            document.getElementById('p2').classList.add('flipped');
        }

        // Обновляем точки
        [1,2,3].forEach(i => {
             document.getElementById('dot'+i).classList.toggle('active', i === n);
        });
        
        currentPage = n;
    }

    // ПРОСТОЙ СВАЙП
    let startX = 0;
    document.addEventListener('touchstart', e => startX = e.touches[0].clientX, {passive: true});
    document.addEventListener('touchend', e => {
        let diff = startX - e.changedTouches[0].clientX;
        if (Math.abs(diff) > 50) {
            if (diff > 0 && currentPage < 3) goToPage(currentPage + 1); // Влево
            else if (diff < 0 && currentPage > 1) goToPage(currentPage - 1); // Вправо
        }
    }, {passive: true});

    // ФУНКЦИИ AI (Упрощенные для стабильности)
    async function send() {
        let txt = document.getElementById('inp').value;
        if(!txt) return;
        let box = document.getElementById('chat-box');
        document.getElementById('inp').value = '';
        
        box.innerHTML += `<div class="user-msg">${txt}</div>`;
        box.scrollTop = box.scrollHeight;

        try {
            let res = await fetch(`https://text.pollinations.ai/prompt/${encodeURIComponent(txt)}`);
            let ans = await res.text();
            box.innerHTML += `<div class="ai-msg">${marked.parse(ans)}</div>`;
            box.scrollTop = box.scrollHeight;
        } catch(e) {
            box.innerHTML += `<div class="ai-msg" style="color:red">Ошибка сети</div>`;
        }
    }

    async function draw() {
        let txt = document.getElementById('art-inp').value;
        if(!txt) return;
        let box = document.getElementById('art-box');
        document.getElementById('art-inp').value = '';
        
        let seed = Math.floor(Math.random()*1000);
        let url = `https://image.pollinations.ai/prompt/${encodeURIComponent(txt)}?seed=${seed}&width=512&height=512&nologo=true`;
        
        box.innerHTML = `<img src="${url}" style="width:100%; border-radius:8px; margin-bottom:10px;">` + box.innerHTML;
    }

    function clearChat() { document.getElementById('chat-box').innerHTML = ''; }
</script>
</body>
</html>
